services:
  # 1. Сервис базы данных PostgreSQL
  db:
    image: postgres:15
    container_name: battle_bot_db
    # Берем данные для БД из твоего database.py
    # user=alwin, password=yourpassword, db=battle_bot_4_pro_max_db
    environment:
      POSTGRES_USER: alwin
      POSTGRES_PASSWORD: yourpassword
      POSTGRES_DB: battle_bot_4_pro_max_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # Перезапускать, если упадет
    restart: unless-stopped

  # 2. Сервис для Телеграм-бота
  bot:
    # Собираем образ из Dockerfile в текущей папке
    build: .
    container_name: battle_bot_tg
    # Команда для запуска из твоего README.md
    command: python main.py
    # Подключаем файл с секретами .env 
    env_file:
      - .env
    environment:
      # ВАЖНО: Переопределяем URL базы данных, чтобы он указывал на сервис 'db'
      # а не на 'localhost', как в database.py
      DATABASE_URL: postgresql+asyncpg://alwin:yourpassword@db:5432/battle_bot_4_pro_max_db
    # Запускать только после того, как запустится 'db'
    depends_on:
      - db
    restart: unless-stopped

  # 3. Сервис для админ-панели
  admin:
    build: . # Используем тот же самый образ
    container_name: battle_bot_admin
    # Команда для запуска из README.md
    # '--host 0.0.0.0' нужен, чтобы uvicorn был доступен снаружи контейнера
    command: uvicorn admin.main:app --host 0.0.0.0 --port 8000 --reload
    volumes:
      # Подключаем код как том, чтобы --reload работал при изменениях
      - .:/app
    ports:
      # Пробрасываем порт 8000 из контейнера на твой компьютер
      - "8000:8000"
    env_file:
      - .env
    environment:
      # Точно так же переопределяем URL базы данных
      DATABASE_URL: postgresql+asyncpg://alwin:yourpassword@db:5432/battle_bot_4_pro_max_db
    depends_on:
      - db
    restart: unless-stopped

# Создаем "том" для хранения данных БД
volumes:
  postgres_data:
